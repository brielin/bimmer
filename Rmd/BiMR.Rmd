```{r}
require(tidyverse)
require(foreach)
require(devtools)
require(scales)
devtools::load_all()
```


```{r}
run_sim <- function(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, r1, r2, n_cores){
  fix_R =  matrix(c(0, r2, r1, 0), nrow = 2, ncol = 2)
  dataset <- generate_dataset(N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, p_net = 0, sd_net = 1, fix_R = fix_R)
  sumstats_select <- dataset$sumstats_select
  sumstats_fit <- dataset$sumstats_fit
  R_cde <- dataset$R_cde
  R_tce <- dataset$R_tce
  beta <- dataset$beta
  
  # First do oracle SNPs and Egger
  mr_method = "egger"
  selected <- select_snps_oracle(beta)
  inst_count <- count_instruments(selected)
  metrics <- instrument_metrics(selected, beta)
  tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
  
  oracle_res <- tibble(
    iter=iter, mr_method = mr_method, p_thresh = NA, w_thresh = NA, 
    r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
    r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
    se1_hat = tce_res$SE_tce[1, 2], se2_hat = tce_res$SE_tce[1, 2],
    p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
    n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
  
  select_res <- foreach(p_thresh = 0.5*0.1^seq(3, 7), .combine = bind_rows) %do% {
    # Do normal egger.
    selected <- select_snps(sumstats_select, p_thresh = p_thresh, welch_thresh = NULL)
    inst_count <- count_instruments(selected)
    tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
    normal_res <- tibble(
      iter=iter, mr_method = mr_method, p_thresh = p_thresh, w_thresh = NA, 
      r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
      r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
      se1_hat = tce_res$SE_tce[1, 2], se2_hat = tce_res$SE_tce[1, 2],
      p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
      n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
    
    # Do weighted xor egger.
    selected <- select_snps(sumstats_select, p_thresh = p_thresh, welch_thresh = 0, weight = TRUE)
    inst_count <- count_instruments(selected)
    tce_res <- fit_tce(sumstats_fit, selected, mr_method = "egger_w")
    weight_res <- tibble(
      iter=iter, mr_method =  "egger_w", p_thresh = p_thresh, w_thresh = 0, 
      r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
      r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
      se1_hat = tce_res$SE_tce[1, 2], se2_hat = tce_res$SE_tce[1, 2],
      p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
      n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
    
    return(bind_rows(normal_res, weight_res))
  }
  result <- bind_rows(oracle_res, select_res)
  result <- unite(
    result, "thresh", c("p_thresh", "w_thresh"), sep = "_", remove = FALSE)
  result <- unite(
    result, "method", c("mr_method", "thresh"), sep = "_", remove = FALSE)
  return(result)
}
```


```{r}
# First simulation: NULL, equal sample sizes, unccorrelated pleiotropy.
n_iter = 1000
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0
doMC::registerDoMC(cores = n_cores)
plot_tibble_1 = foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
  run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
}
save(plot_tibble_1, file = "~/ukbb_network/plot_data/bimr_sim_1.Rdata")
```


```{r}
# Second simulation: NULL, equal sample sizes, correlated pleiotropy.
n_iter = 1000
N = 100000
n_cores = 24
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 1 # Total genetic correlarion 0.2.
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0

plot_tibble_2 = foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
  run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
}
save(plot_tibble_2, file = "~/ukbb_network/plot_data/bimr_sim_2.Rdata")
```


```{r}
# Third simulation: NULL, unequal sample sizes, unequal polygencity correlated pleiotropy.
n_iter = 1000
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = c(0.2, 0.333) # Shared SNPs are twice as large as private SNPs in pheno 2.
M_total = 1000000
D = 2

rho = 1 # Total genetic correlarion 0.2.
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0

plot_tibble_3 = foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
  run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
}
save(plot_tibble_3, file = "~/ukbb_network/plot_data/bimr_sim_3.Rdata")
```


```{r}
# Fourth simulation: ALT, various values of effect size.
n_iter = 240
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- c(0.05, 0.1, 0.2, 0.31, 0.55, 0.85) # seq(0.05, 0.8, 0.05)
r2 = 0

plot_tibble_4 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
    run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
  }
}
save(plot_tibble_4, file = "~/ukbb_network/plot_data/bimr_sim_4.Rdata")
```


```{r}
# Fifth simulation: ALT, various values of effect size, larger sample 1.
n_iter = 240
n_cores = 24
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <-  c(0.05, 0.1, 0.2, 0.31, 0.55, 0.85)
r2 = 0

plot_tibble_5 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
    run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
  }
}

save(plot_tibble_5, file = "~/ukbb_network/plot_data/bimr_sim_5.Rdata")
```


```{r}
# Sixth simulation: ALT, various values of effect size, larger sample 2.
n_iter = 240
n_cores = 24
N = c(50000, 200000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- c(0.05, 0.1, 0.2, 0.31, 0.55, 0.85)
r2 = 0

plot_tibble_6 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
    run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
  }
}
save(plot_tibble_6, file = "~/ukbb_network/plot_data/bimr_sim_6.Rdata")
```


```{r}
# Seventh simulation: TWO-WAY ALT, various values of effect size, equal sample sizes.
n_iter = 120
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- c(-0.55, -0.28, -0.1, 0.1, 0.28, 0.55)
r2_values <- c(-0.55, -0.28, -0.1, 0.1, 0.28, 0.55)

plot_tibble_7 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(r2 = r2_values, .combine = bind_rows) %do% {
    foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
      run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
    }
  }
}
save(plot_tibble_7, file = "~/ukbb_network/plot_data/bimr_sim_7.Rdata")
```


```{r}
# Eigth simulation: TWO-WAY ALT, various values of effect size, unequal sample sizes.
n_iter = 120
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- c(-0.55, -0.28, -0.1, 0.1, 0.28, 0.55)
r2_values <- c(-0.55, -0.28, -0.1, 0.1, 0.28, 0.55)

plot_tibble_8 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(r2 = r2_values, .combine = bind_rows) %do% {
    foreach(iter = 1:n_iter, .combine = bind_rows) %dopar% {
      run_sim(iter = iter, N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, r1 = r1, r2 = r2)
    }
  }
}
save(plot_tibble_8, file = "~/ukbb_network/plot_data/bimr_sim_8.Rdata")
```


```{r}
se <- function(x, na.rm = FALSE){
  sqrt(var(x, na.rm = na.rm)/length(x))
}

make_summary_tibble <- function(plot_tibble, name1 = "fwer1", name2 = "fwer2"){
  summary_tibble <- plot_tibble %>% group_by(method, r1_sim, r2_sim) %>% 
    mutate(!!name1 := mean(p1 < 0.05, na.rm=T), !!name2 := mean(p2 < 0.05, na.rm=T),
           !!paste0("se_", name1) := se(p1 < 0.05, na.rm=T), !!paste0("se_", name2) := se(p2 < 0.05, na.rm=T),
           mae1 = mean(abs(r1 - r1_hat), na.rm=T), mae2 = mean(abs(r2 - r2_hat), na.rm=T),
           se_mae1 = se(abs(r1 - r1_hat), na.rm=T), se_mae2 = se(abs(r2 - r2_hat), na.rm=T),
           r1_hat = mean(r1_hat, na.rm=T), r2_hat = mean(r2_hat, na.rm=T),
           se1_hat = mean(se1_hat, na.rm=T), se2_hat = mean(se2_hat, na.rm=T),
           n1_mean = mean(n1), n2_mean = mean(n2), se_n1 = se(n1), se_n2 = se(n2),
           obs1 = mean(!is.na(r1_hat)), obs2 = mean(!is.na(r2_hat)),
           se_obs1 = se(!is.na(r1_hat)), se_obs2 = se(!is.na(r2_hat)),
           r1 = mean(r1), r2 = mean(r2)) %>% ungroup() %>%
    distinct(method, mr_method, thresh, p_thresh, w_thresh, r1, r2, !!sym(name1), !!sym(name2),
             !!sym(paste0("se_", name1)), !!sym(paste0("se_", name2)), mae1, mae2, se_mae1, se_mae2, r1_hat, r2_hat, se1_hat, se2_hat, n1_mean, n2_mean,
             se_n1, se_n2, obs1, obs2, se_obs1, se_obs2)
  return(summary_tibble)
}

reverselog_trans <- function(base = exp(1)) {
    trans <- function(x) -log(x, base)
    inv <- function(x) base^(-x)
    trans_new(paste0("reverselog-", format(base)), trans, inv,
                      log_breaks(base = base), domain = c(1e-100, Inf))
}
```

```{r}
# Load data and make summaries.
load("~/ukbb_network/plot_data/bimr_sim_1_raps.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_2_raps.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_3_raps.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_4_raps.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_5_raps.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_6_raps.Rdata")

summary_tibble_1 <- make_summary_tibble(plot_tibble_1, name1 = "fwer1", name2 = "fwer2")
summary_tibble_2 <- make_summary_tibble(plot_tibble_2, name1 = "fwer1", name2 = "fwer2")
summary_tibble_3 <- make_summary_tibble(plot_tibble_3, name1 = "fwer1", name2 = "fwer2")
summary_tibble_4 <- make_summary_tibble(plot_tibble_4, name1 = "power1", name2 = "fwer2")
summary_tibble_5 <- make_summary_tibble(plot_tibble_5, name1 = "power1", name2 = "fwer2")
summary_tibble_6 <- make_summary_tibble(plot_tibble_6, name1 = "power1", name2 = "fwer2")

```

```{r}
# Figure 1 and Supplementary Figure 1 panels:
load("~/ukbb_network/plot_data/bimr_sim_1.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_2.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_3.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_4.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_5.Rdata")
load("~/ukbb_network/plot_data/bimr_sim_6.Rdata")

summary_tibble_1 <- make_summary_fwer_tibble(plot_tibble_1)
summary_tibble_2 <- make_summary_fwer_tibble(plot_tibble_2)
summary_tibble_3 <- make_summary_fwer_tibble(plot_tibble_3)
summary_tibble_4 <- make_summary_power_tibble(plot_tibble_4)
summary_tibble_5 <- make_summary_power_tibble(plot_tibble_5)
summary_tibble_6 <- make_summary_power_tibble(plot_tibble_6)

# S1A
summary_tibble_1 %>% filter(!is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, fwer2, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=fwer2-se_fwer2, ymax=fwer2+se_fwer2)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1B
summary_tibble_2 %>% filter(!is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, fwer2, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=fwer2-se_fwer2, ymax=fwer2+se_fwer2)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = "q threshold") + ylim(0, 1)

# S1C
summary_tibble_3 %>% filter(!is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, fwer2, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=fwer2-se_fwer2, ymax=fwer2+se_fwer2)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = "q threshold") + ylim(0, 1)

# S1D
summary_tibble_4 %>% filter(r1_sim == 0.11, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1E
summary_tibble_5 %>% filter(r1_sim == 0.11, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1F
summary_tibble_6 %>% filter(r1_sim == 0.11, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1G
summary_tibble_4 %>% filter(r1_sim == 0.35, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1H
summary_tibble_5 %>% filter(r1_sim == 0.35, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)

# S1I
summary_tibble_6 %>% filter(r1_sim == 0.35, !is.na(p_thresh), !is.na(w_thresh), w_thresh != 0) %>%
  ggplot(aes(w_thresh, power1, color = as.character(p_thresh))) + geom_line() +
  geom_errorbar(aes(ymin=power1-se_power1, ymax=power1+se_power1)) +
  scale_x_continuous(trans=reverselog_trans(10)) + 
  labs(color='p threshold', x = 'q threshold') + ylim(0, 1)
```


```{r}
plot_tibble <- 


# Table results
summary_tibble <- plot_tibble %>% distinct(method, FWER1, se_fwer1, FWER2, se_fwer2, mae1, se_mae1, mae2, se_mae2, obs1, obs2, se_obs1, se_obs2)
print(summary_tibble)
# FWER
# summary_tibble %>% ggplot(aes(x = method, y = FWER1)) +
#   geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   geom_errorbar(aes(ymin=FWER1-se_fwer1, ymax=FWER1+se_fwer1))
# summary_tibble %>% distinct(method, FWER2, se_fwer2) %>% ggplot(aes(x = method, y = FWER2)) +
#   geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   geom_errorbar(aes(ymin=FWER2-se_fwer2, ymax=FWER2+se_fwer2))
# # MAE
# summary_tibble %>% ggplot(aes(x = method, y = mae1)) +
#   geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   geom_errorbar(aes(ymin=mae1-se_mae1, ymax=mae1+se_mae1))
# summary_tibble %>% ggplot(aes(x = method, y = mae2)) +
#   geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#   geom_errorbar(aes(ymin=mae2-se_mae2, ymax=mae2+se_mae2))
# # plot_tibble %>% ggplot(aes(x = method, y = abs(r1_hat - r1))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# # plot_tibble %>% ggplot(aes(x = method, y = abs(r2_hat - r2))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# # Number of instruments
# plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# plot_tibble %>% ggplot(aes(x = method, y = n2)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# # Perc of time giving an answer
# plot_tibble %>% distinct(method, obs1) %>% ggplot(aes(x = method, y = obs1)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# plot_tibble %>% distinct(method, obs2) %>% ggplot(aes(x = method, y = obs2)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

