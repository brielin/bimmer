```{r}
require(tidyverse)
require(foreach)
require(devtools)
devtools::load_all()
```
```{r}
run_sim <- function(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2,  n_cores){
  fix_R =  matrix(c(0, r2, r1, 0), nrow = 2, ncol = 2)
  doMC::registerDoMC(cores = n_cores)
  plot_tibble <- foreach(i = 1:n_iter, .combine = bind_rows) %dopar% {
    dataset <- generate_dataset(N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, p_net = 0, sd_net = 1, fix_R = fix_R)
    sumstats_select <- dataset$sumstats_select
    sumstats_fit <- dataset$sumstats_fit
    R_cde <- dataset$R_cde
    R_tce <- dataset$R_tce
    beta <- dataset$beta
  
    # First do oracle SNPs and Egger
    mr_method = "egger_p"
    selected <- select_snps_oracle(beta)
    inst_count <- count_instruments(selected)
    metrics <- instrument_metrics(selected, beta)
    tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
  
    oracle_res <- tibble(
      iter=i, mr_method = mr_method, p_thresh = NA, w_thresh = NA, 
      r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
      r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
      p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
      n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
  
    select_res <- foreach(p_thresh = 0.5*0.1^seq(1, 7), .combine = bind_rows) %do% {
      selected <- select_snps(sumstats_select, p_thresh = p_thresh, welch_thresh = NULL)
      inst_count <- count_instruments(selected)
      tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
      no_welch_res <- tibble(
        iter=i, mr_method = mr_method, p_thresh = p_thresh, w_thresh = NA, 
        r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
        r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
        p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
        n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
    
      welch_res <- foreach(w_thresh = c(0.05, 0.01, 0.005, 0.001, 0.0005, 0.0001), .combine = bind_rows) %do% {
        selected <- select_snps(sumstats_select, p_thresh = p_thresh, welch_thresh = w_thresh)
        inst_count <- count_instruments(selected)
        tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
        tibble(
          iter=i, mr_method = mr_method, p_thresh = p_thresh, w_thresh = w_thresh, 
          r1_sim = r1, r2_sim = r2, r1 = R_tce[1,2], r2 = R_tce[2, 1],
          r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
          p1 = tce_res$p_val[1,2], p2 = tce_res$p_val[2,1],
          n1 = inst_count[1,2][[1]], n2 = inst_count[2,1][[1]])
      }
      bind_rows(no_welch_res, welch_res)
    }
    bind_rows(oracle_res, select_res)
  }
  plot_tibble <- unite(
    plot_tibble, "thresh", c("p_thresh", "w_thresh"), sep = "_", remove = FALSE)
  plot_tibble <- unite(
    plot_tibble, "method", c("mr_method", "thresh"), sep = "_", remove = FALSE)
  return(plot_tibble)
}

se <- function(x){
  sqrt(var(x)/length(x))
}
```


```{r}
# First simulation: NULL, equal sample sizes, unccorrelated pleiotropy.
n_iter = 8
n_cores = 8
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 2

rho = 0
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0
plot_tibble_1 = run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
save(plot_tibble_1, file = "~/Work/bimmer/plot_data/bimr_sim_1.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method) %>% 
  mutate(FWER1 = mean(p1 < 0.05), FWER2 = mean(p2 < 0.05),
         se_fwer1 = se(p1 < 0.05), se(p2 < 0.05),
         mae1 = mean(abs(r1 - r1_hat)), mae2 = mean(abs(r2 - r2_hat)),
         se_mae1 = se(abs(r1 - r1_hat)), se_mae1 = se(abs(r2 - r2_hat)),
         obs1 = mean(!is.na(r1_hat)), obs2 = mean(!is.na(r2_hat)),
         se_obs1 = se(!is.na(r1_hat)), se_obs2 = se(!is.na(r2_hat))) %>% ungroup()

# FWER
plot_tibble %>% distinct(method, FWER1) %>% ggplot(aes(x = method, y = FWER1)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% distinct(method, FWER2) %>% ggplot(aes(x = method, y = FWER2)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# MAE
plot_tibble %>% ggplot(aes(x = method, y = abs(r1_hat - r1))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = abs(r2_hat - r2))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# Number of instruments
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = n2)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
# Perc of time giving an answer
plot_tibble %>% distinct(method, obs1) %>% ggplot(aes(x = method, y = obs1)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% distinct(method, obs2) %>% ggplot(aes(x = method, y = obs2)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Second simulation: NULL, equal sample sizes, correlated pleiotropy.
niter = 100
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 1 # Total genetic correlarion 0.2.
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0

plot_tibble_2 = run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
save(plot_tibble_2, file = "~/Work/bimmer/plot_data/bimr_sim_2.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method) %>% 
  mutate(FWER1 = mean(p1 < 0.05), FWER2 = mean(p2 < 0.05),
         se_fwer1 = se(p1 < 0.05), se(p2 < 0.05),
         mae1 = mean(abs(r1 - r1_hat)), mae2 = mean(abs(r2 - r2_hat)),
         se_mae1 = se(abs(r1 - r1_hat)), se_mae1 = se(abs(r2 - r2_hat))) %>% ungroup()

plot_tibble %>% distinct(method, FWER1) %>% ggplot(aes(x = method, y = FWER1)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% distinct(method, FWER2) %>% ggplot(aes(x = method, y = FWER2)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = abs(r1_hat - r1))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = abs(r2_hat - r2))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = n2)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Third simulation: NULL, unequal sample sizes, unequal polygencity correlated pleiotropy.
niter = 500
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = c(0.2, 0.333) # Shared SNPs are twice as large as private SNPs in pheno 2.
M_total = 100000
D = 2

rho = 1 # Total genetic correlarion 0.2.
noise = 0.8 # 20% heritability
r1 = 0 # NULL
r2 = 0

plot_tibble_3 = run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
save(plot_tibble_3, file = "~/Work/bimmer/plot_data/bimr_sim_3.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method) %>% 
  mutate(FWER1 = mean(p1 < 0.05), FWER2 = mean(p2 < 0.05),
         se_fwer1 = se(p1 < 0.05), se(p2 < 0.05),
         mae1 = mean(abs(r1 - r1_hat)), mae2 = mean(abs(r2 - r2_hat)),
         se_mae1 = se(abs(r1 - r1_hat)), se_mae1 = se(abs(r2 - r2_hat))) %>% ungroup()

plot_tibble %>% distinct(method, FWER1) %>% ggplot(aes(x = method, y = FWER1)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% distinct(method, FWER2) %>% ggplot(aes(x = method, y = FWER2)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = abs(r1_hat - r1))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = abs(r2_hat - r2))) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot_tibble %>% ggplot(aes(x = method, y = n2)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Fourth simulation: ALT, various values of effect size.
niter = 100
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- seq(0.05, 0.8, 0.05)
r2 = 0

plot_tibble_4 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
}
save(plot_tibble_4, file = "~/Work/bimmer/plot_data/bimr_sim_4.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method, r1_sim) %>% 
  mutate(Power = mean(p1 < 0.05, na.rm=T),
         se_power = sqrt(var(p1 < 0.05)/niter),
         mae = mean(abs(r1 - r1_hat)),
         se_mae = sqrt(var(abs(r1 - r1_hat))/niter)) %>% ungroup()

pd <- position_dodge(0.05)
plot_tibble %>% distinct(method, r1_sim, Power, se_power) %>% ggplot(aes(r1_sim, Power, color = method)) + 
  geom_line(position = pd) + geom_errorbar(aes(ymin=Power-se_power, ymax=Power+se_power), width=0.01, position=pd)
plot_tibble %>% distinct(method, r1_sim, mae, se_mae) %>% ggplot(aes(x = r1_sim, y = mae, color = method)) + geom_line(position=pd) + geom_errorbar(aes(ymin=mae-se_mae, ymax=mae+se_mae), width=0.01, position=pd)
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Fifth simulation: ALT, various values of effect size, larger sample 1.
niter = 100
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- seq(0.05, 0.8, 0.05)
r2 = 0

plot_tibble_5 <- foreach(r = r_values, .combine = bind_rows) %do% {
  run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
}
save(plot_tibble_5, file = "~/Work/bimmer/plot_data/bimr_sim_5.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method, r1_sim) %>% 
  mutate(Power = mean(p1 < 0.05, na.rm=T),
         se_power = sqrt(var(p1 < 0.05)/niter),
         mae = mean(abs(r1 - r1_hat)),
         se_mae = sqrt(var(abs(r1 - r1_hat))/niter)) %>% ungroup()

pd <- position_dodge(0.05)
plot_tibble %>% distinct(method, r1_sim, Power, se_power) %>% ggplot(aes(r1_sim, Power, color = method)) + 
  geom_line(position = pd) + geom_errorbar(aes(ymin=Power-se_power, ymax=Power+se_power), width=0.01, position=pd)
plot_tibble %>% distinct(method, r1_sim, mae, se_mae) %>% ggplot(aes(x = r1_sim, y = mae, color = method)) + geom_line(position=pd) + geom_errorbar(aes(ymin=mae-se_mae, ymax=mae+se_mae), width=0.01, position=pd)
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Sixth simulation: ALT, various values of effect size, larger sample 2.
niter = 100
N = c(50000, 200000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- seq(0.05, 0.8, 0.05)
r2 = 0

plot_tibble_6 <- foreach(r = r_values, .combine = bind_rows) %do% {
  run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
}
save(plot_tibble_6, file = "~/Work/bimmer/plot_data/bimr_sim_7.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method, r1_sim) %>% 
  mutate(Power = mean(p1 < 0.05, na.rm=T),
         se_power = sqrt(var(p1 < 0.05)/niter),
         mae = mean(abs(r1 - r1_hat)),
         se_mae = sqrt(var(abs(r1 - r1_hat))/niter)) %>% ungroup()

pd <- position_dodge(0.05)
plot_tibble %>% distinct(method, r1_sim, Power, se_power) %>% ggplot(aes(r1_sim, Power, color = method)) + 
  geom_line(position = pd) + geom_errorbar(aes(ymin=Power-se_power, ymax=Power+se_power), width=0.01, position=pd)
plot_tibble %>% distinct(method, r1_sim, mae, se_mae) %>% ggplot(aes(x = r1_sim, y = mae, color = method)) + geom_line(position=pd) + geom_errorbar(aes(ymin=mae-se_mae, ymax=mae+se_mae), width=0.01, position=pd)
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Seventh simulation: TWO-WAY ALT, various values of effect size, equal sample sizes.
niter = 100
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- seq(0.05, 0.8, 0.05)
r2_values <- seq(0.05, 0.8, 0.05)

plot_tibble_7 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(r2 = r2_values, .combine = bind_rows) %do% {
    run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
  }
}
save(plot_tibble_7, file = "~/Work/bimmer/plot_data/bimr_sim_7.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method, r1_sim) %>% 
  mutate(Power = mean(p1 < 0.05, na.rm=T),
         se_power = sqrt(var(p1 < 0.05)/niter),
         mae = mean(abs(r1 - r1_hat)),
         se_mae = sqrt(var(abs(r1 - r1_hat))/niter)) %>% ungroup()

# Plot options: PWR1, PWR2, PWR_both, MAE1, MAE2, MAE_both.
pd <- position_dodge(0.05)
plot_tibble %>% distinct(method, r1_sim, Power, se_power) %>% ggplot(aes(r1_sim, Power, color = method)) + 
  geom_line(position = pd) + geom_errorbar(aes(ymin=Power-se_power, ymax=Power+se_power), width=0.01, position=pd)
plot_tibble %>% distinct(method, r1_sim, mae, se_mae) %>% ggplot(aes(x = r1_sim, y = mae, color = method)) + geom_line(position=pd) + geom_errorbar(aes(ymin=mae-se_mae, ymax=mae+se_mae), width=0.01, position=pd)
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Eigth simulation: TWO-WAY ALT, various values of effect size, unequal sample sizes.
niter = 100
N = c(200000, 50000)
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 100000
D = 2

rho = 0 # No genetic correlation.
noise = 0.8 # 20% heritability
r1_values <- seq(0.05, 0.8, 0.05)
r2_values <- seq(0.05, 0.8, 0.05)

plot_tibble_8 <- foreach(r1 = r1_values, .combine = bind_rows) %do% {
  foreach(r2 = r2_values, .combine = bind_rows) %do% {
    run_sim(n_iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, p_net, sd_net, r1, r2, n_cores)
  }
}
save(plot_tibble_8, file = "~/Work/bimmer/plot_data/bimr_sim_8.Rdata")
```

```{r}
plot_tibble <- plot_tibble %>% group_by(method, r1_sim) %>% 
  mutate(Power = mean(p1 < 0.05, na.rm=T),
         se_power = sqrt(var(p1 < 0.05)/niter),
         mae = mean(abs(r1 - r1_hat)),
         se_mae = sqrt(var(abs(r1 - r1_hat))/niter)) %>% ungroup()

pd <- position_dodge(0.05)
plot_tibble %>% distinct(method, r1_sim, Power, se_power) %>% ggplot(aes(r1_sim, Power, color = method)) + 
  geom_line(position = pd) + geom_errorbar(aes(ymin=Power-se_power, ymax=Power+se_power), width=0.01, position=pd)
plot_tibble %>% distinct(method, r1_sim, mae, se_mae) %>% ggplot(aes(x = r1_sim, y = mae, color = method)) + geom_line(position=pd) + geom_errorbar(aes(ymin=mae-se_mae, ymax=mae+se_mae), width=0.01, position=pd)
plot_tibble %>% ggplot(aes(x = method, y = n1)) + geom_violin() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
### OLD ###
N = 20000
N_ind = c(2500, 10000)
M = 1000
D = 2
noise = 0.5
sd_net = 0.5
sd_beta = 0.4
p_net = 0.8
p_beta = 0.4
niter = 1000
M_null = 100000
mr_methods = c("raps", "egger")

doMC::registerDoMC(cores = 32)
plot_tibble <- foreach(i = 1:niter,
                       .combine = bind_rows,
                       .inorder = FALSE) %dopar% {
  dataset = generate_dataset(
    N, M, D, noise = noise, p_net = p_net,
    sd_beta = sd_beta, p_beta = p_beta, sd_net = sd_net, pleiotropy = FALSE)
  Y_sds <- apply(dataset$Y, 2, sd)
  R_obs = get_observed(dataset$R)
  R_tce = get_tce(R_obs, normalize=Y_sds)
  R_normed <- fit_exact(R_tce)$R_hat

  sample <- sample.int(n = N, size = floor(N/2), replace = FALSE)
  X_select = dataset$X[sample, ]
  Y_select = dataset$Y[sample, ]
  X_fit = dataset$X[-sample, ]
  Y_fit = dataset$Y[-sample, ]
  sumstats_select = generate_sumstats(
    X_select, Y_select, N_ind = N_ind, M_null = M_null)
  sumstats_fit = generate_sumstats(X_fit, Y_fit, N_ind = N_ind, M_null = M_null)

  selected <- select_snps_oracle(dataset$beta)
  metrics <- instrument_metrics(selected, dataset$beta)
  oracle_res <- foreach(mr_method = mr_methods, .combine = bind_rows) %do% {
    tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
    tibble(iter=i, mr_method = mr_method, p_thresh = 0, w_thresh = 0, 
           r1 = R_normed[1,2], r2 = R_normed[2, 1],
           r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
           n1_inst = sum(selected$P1$P2), n2_inst = sum(selected$P2$P1),
           n1_precision = metrics$P1$P2[1], n2_precision = metrics$P2$P1[1],
           n1_recall = metrics$P1$P2[2], n2_recall = metrics$P2$P1[2],
           n1_reversed = metrics$P1$P2[3], n2_reversed = metrics$P2$P1[3])
  }

  select_res <- foreach(p_thresh = 0.5*0.1^seq(1, 7),
                        .combine = bind_rows) %do% {
    foreach(w_thresh = c(1, 0.5^seq(1, 15))) %do% {
      w_thresh_use = w_thresh
      if(w_thresh == 1){
        w_thresh_use = NULL
      }
      selected <- select_snps(
        sumstats_select, p_thresh = p_thresh, welch_thresh = w_thresh_use)
      metrics <- instrument_metrics(selected, dataset$beta)
      foreach(mr_method = mr_methods, .combine = bind_rows) %do% {
        tce_res <- fit_tce(sumstats_fit, selected, mr_method = mr_method)
        tibble(iter=i, mr_method = mr_method, p_thresh = p_thresh,
               w_thresh = w_thresh, r1 = R_normed[1,2], r2 = R_normed[2, 1],
              r1_hat = tce_res$R_tce[1, 2], r2_hat = tce_res$R_tce[2, 1],
              n1_inst = sum(selected$P1$P2), n2_inst = sum(selected$P2$P1),
              n1_precision = metrics$P1$P2[1], n2_precision = metrics$P2$P1[1],
              n1_recall = metrics$P1$P2[2], n2_recall = metrics$P2$P1[2],
              n1_reversed = metrics$P1$P2[3], n2_reversed = metrics$P2$P1[3])
      }
    }
  }
  dplyr::bind_rows(oracle_res, select_res)
}
```

```{r}
plot_tibble <- unite(
  plot_tibble, "thresh", c("p_thresh", "w_thresh"), sep = "_", remove = FALSE)
plot_tibble <- plot_tibble %>%
  mutate(thresh = if_else(thresh == "0_0", "oracle", thresh))
plot_tibble <- plot_tibble %>% 
  mutate(thresh = if_else(
    w_thresh == 1, paste0(as.character(p_thresh), "_na"), thresh))
plot_tibble <- unite(
  plot_tibble, "method", c("mr_method", "thresh"), sep = "_", remove = FALSE)
plot_tibble <- plot_tibble %>% 
  mutate(obs_both = !is.na(r1_hat) & !is.na(r2_hat))


plot_tibble <- plot_tibble %>% group_by(method) %>% mutate(
  r1_mae=mean(abs(r1_hat - r1), na.rm=T),
  r2_mae=mean(abs(r2_hat - r2), na.rm=T),
  r1_me=mean(r1_hat - r1, na.rm=T),
  r2_me=mean(r2_hat - r2, na.rm=T),
  total_mae=mean(abs(r1-r1_hat) + abs(r2-r2_hat), na.rm=T),
  r1_95=quantile(abs(r1_hat - r1), probs = 0.95, na.rm=T),
  r2_95=quantile(abs(r2_hat - r2), probs = 0.95, na.rm=T),
  total_95=quantile(abs(r1_hat - r1) + abs(r2_hat - r2), probs = 0.95, na.rm=T),
  r1_obs_perc=sum(!is.na(r1_hat))/niter,
  r2_obs_perc=sum(!is.na(r2_hat))/niter,
  obs_both_perc=sum(obs_both)/niter,
  n1_inst_ave = mean(n1_inst),
  n2_inst_ave = mean(n2_inst),
  n1_rev_ave = mean(n1_reversed, na.rm=T),
  n2_rev_ave = mean(n2_reversed, na.rm=T),
  n1_prec_ave = mean(n1_precision, na.rm=T),
  n2_prec_ave = mean(n2_precision, na.rm=T),
  n1_recall_ave = mean(n1_recall),
  n2_recall_ave = mean(n2_recall)) %>% ungroup()

save(plot_tibble, file = "../saved_rdata/threshold_results.Rdata")
```

```{r}
load("../saved_rdata/threshold_results.Rdata")

reverselog_trans <- function(base = exp(1)) {
    trans <- function(x) -log(x, base)
    inv <- function(x) base^(-x)
    scales::trans_new(paste0("reverselog-", format(base)), trans, inv,
                      log_breaks(base = base), domain = c(1e-100, Inf))
}

for(p_thresh in c(5e-04, 5e-06, 5e-08)){
  plot_tibble %>% 
    filter(mr_method == "egger", p_thresh == p_thresh, abs(r1) > 0.5) %>%
    ggplot(aes(w_thresh, n2_reversed)) + 
    geom_jitter(height = 0.01, width = 0.05, alpha = 0.5) + 
    scale_x_continuous(trans=reverselog_trans(10))
  
  plot_tibble %>% 
    filter(mr_method == "egger", p_thresh == p_thresh, abs(r1) > 0.5) %>%
    ggplot(aes(w_thresh, obs_both_perc)) + 
    geom_jitter(height = 0.01, width = 0.05, alpha = 0.5) + 
    scale_x_continuous(trans=reverselog_trans(10))
  
  plot_tibble %>% 
    filter(mr_method == "egger", p_thresh == p_thresh, abs(r1) > 0.5) %>%
    ggplot(aes(w_thresh, n2_inst)) + 
    geom_jitter(height = 0.01, width = 0.05, alpha = 0.5) + 
    scale_x_continuous(trans=reverselog_trans(10))
}

plot_tibble %>% 
  filter(mr_method == "egger", p_thresh == "5e-04",
         w_thresh == 1 | w_thresh == 0.125) %>%
  mutate(w_thresh = if_else(w_thresh == 1, "None", "0.125")) %>% 
  ggplot(aes(abs(r1), abs(r2-r2_hat), color = w_thresh)) + geom_point()

plot_tibble %>% 
  filter(mr_method == "raps", p_thresh == "5e-04",
         w_thresh == 1 | w_thresh == 0.125) %>%
  mutate(w_thresh = if_else(w_thresh == 1, "None", "0.125")) %>% 
  ggplot(aes(abs(r1), abs(r2-r2_hat), color = w_thresh)) + geom_point()

plot_tibble %>% 
  filter(mr_method == "egger",
         p_thresh %in% c("0.05", "5e-04", "5e-06", "5e-08"),
         w_thresh %in% c(1, 0.5, 0.125, 3.125000e-02, 7.812500e-03,
                         1.953125e-03, 4.8828125e-04)) %>%
  distinct(p_thresh, w_thresh, total_mae) %>%
  pivot_wider(names_from = p_thresh, values_from = total_mae)

plot_tibble %>% 
  filter(mr_method == "raps",
         p_thresh %in% c("0.05", "5e-04", "5e-06", "5e-08"),
         w_thresh %in% c(1, 0.5, 0.125, 3.125000e-02, 7.812500e-03,
                         1.953125e-03, 4.8828125e-04)) %>%
  distinct(p_thresh, w_thresh, total_mae) %>%
  pivot_wider(names_from = p_thresh, values_from = total_mae)
```


```{r}
# Plot to show success/failure of raps/egger on completely NULL SNPs. 
N1 = 10000
N2 = 10000
Ninst = 100
niter = 100

plot_tibble <- foreach(i = 1:niter, .combine = bind_rows) %do% {
  b1 = rnorm(Ninst, 0, 1/sqrt(N1))
  b2 = rnorm(Ninst, 0, 1/sqrt(N2))
  s1 = rep(1/sqrt(N1), Ninst)
  s2 = rep(1/sqrt(N2), Ninst)
  input <- MendelianRandomization::mr_input(
    bx = b1, bxse = s1, by = b2, byse = s2)
  raps_res <- mr.raps::mr.raps(b1, b2, s1, s2, loss.function = "huber")
  egger_res <- MendelianRandomization::mr_egger(input)
  tibble(method=c("raps", "egger"),
         beta=c(raps_res$beta.hat, egger_res$Estimate),
         se=c(raps_res$beta.se, egger_res$StdError.Est))
}

plot_tibble %>% group_by(method) %>% 
  mutate(mean_abs_beta = mean(abs(beta)),
         mean_se = mean(se), max_se = max(se)) %>% 
  distinct(method, mean_abs_beta, mean_se, max_se)
```
