---
title: "simulate"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load packages
```{r}
require(tidyverse)
require(foreach)
require(inspre)
require(devtools)
require(huge)
require(egg)
devtools::load_all()
```


```{r}
run_methods <- function(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient){
  R <- generate_network(D = D, graph = graph, prob = prob, g = g, v = v, orient = orient)
  dataset <- generate_dataset(N = N, D = D, M_total = M_total, M_s = M_s, M_p = M_p, prop_shared = prop_shared, rho = rho, noise = noise, fix_R = R)
  sumstats_select <- dataset$sumstats_select
  sumstats_fit <- dataset$sumstats_fit
  R_cde <- dataset$R_cde
  R_tce <- dataset$R_tce
  beta <- dataset$beta
  
  # Calculate the self-influence of each node to track during simulations.
  R_obs = get_observed(R_cde)
  self_norm = 1 + diag(R_obs)
  min_abs_self = min(abs(self_norm))
  min_self = min(self_norm)
  max_self = max(self_norm)
  
  selected_bimmer <- select_snps(sumstats_select, p_thresh = 5e-6, welch_thresh = 0, weight = TRUE)
  selected_standard <- select_snps(sumstats_select, p_thresh = 5e-8, welch_thresh = NULL)
  tce_res <- fit_tce(sumstats_fit, selected_bimmer, mr_method = "egger_w")
  n_tce_nans <- sum(is.na(tce_res$R_tce))
  mae_tce <- mean(abs(tce_res$R_tce - R_tce), na.rm=T)
  rmse_tce <- sqrt(mean((tce_res$R_tce - R_tce)**2, na.rm=T))
  mean_missing <- mean(abs(R_tce[is.na(tce_res$R_tce)]))
  max_row_missing <- max(rowSums(is.na(tce_res$R_tce)))
  max_col_missing <- max(colSums(is.na(tce_res$R_tce)))
  print(c(mae_tce, mean(purrr::map_int(selected_bimmer, function(x){length(x[["names"]])}))))

  # methods = c("inspre", "exact", "mvmr")
  # result <- foreach(method = methods, .combine = bind_rows) %do% {
  #   D_hat = NULL
  #   lambda = NULL
  #   if(method == "exact"){
  #     R_hat <- fit_exact(tce_res$R_tce)$R_hat
  #     R_hat <- array(R_hat, dim = c(D, D, 1))
  #   } else if (method == "mvmr") {
  #     R_hat <- fit_mvmr(sumstats_fit, selected_standard)$R_hat
  #     R_hat <- array(R_hat, dim = c(D, D, 1))
  #   } else if (method == "inspre"){
  #     weights <- inspre::make_weights(tce_res$SE_tce)
  #     cde_res <- fit_inspre(R_tce = tce_res$R_tce, W = weights, cv_folds = 5, verbose = 1, lambda_min_ratio = 0.1, nlambda = 25, warm_start = FALSE)
  #     R_hat <- cde_res$R_hat
  #     D_hat <- cde_res$D_hat
  #     lambda <- cde_res$lambda
  #   }
  #   metrics <- map_dfr(array_tree(R_hat, 3), function(t){calc_metrics(t, R_cde)})
  #   metrics$D_hat <- D_hat
  #   metrics$lambda <- lambda
  #   metrics$iter <- iter
  #   metrics$min_abs_self <- min_abs_self
  #   metrics$method <- method
  #   metrics$n_tce_nans <- n_tce_nans
  #   metrics$mean_missing <- mean_missing
  #   metrics$max_row_missing <- max_row_missing
  #   metrics$max_col_missing <- max_col_missing
  #   metrics$mae_tce <- mae_tce
  #   metrics$rmse_tce <- rmse_tce
  #   return(metrics)
  # }
  # return(result)
}
```


```{r}
# First simulation: ER graphs, random direction.
n_iter = 24
n_cores = 24
N = 100000
M_s = 1000
M_p = 2000
M_total = 250000
D = 100
graph = "random"
prob = 0.04
g = NULL
v = 0.3
orient = "random"

rho = 0
noise = 0.8 # 20% heritability

doMC::registerDoMC(cores = n_cores)
# plot_tibble_1 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
for(iter in 1:n_iter){
  N <- round(runif(D, min = 50000, max = 150000))
  prop_shared <- runif(D, min = 0.2, max = 0.4)
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_1, file = "~/ukbb_network/plot_data/bimmer_sim_1.Rdata")
```


```{r}
# Second simulation: ER graphs, towards direction.
n_iter = 24
n_cores =24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "random"
prob = 0.04
g = NULL
v = 0.3
orient = "towards"

rho = 0
noise = 0.8 # 20% heritability

doMC::registerDoMC(cores = n_cores)
# plot_tibble_2 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
for(iter in 1:n_iter){
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_2, file = "~/ukbb_network/plot_data/bimmer_sim_2.Rdata")
```


```{r}
# Third simulation: ER graphs, away direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "random"
prob = 0.04
g = NULL
v = 0.3
orient = "away"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
# plot_tibble_3 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
for(iter in 1:n_iter){
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_3, file = "~/ukbb_network/plot_data/bimmer_sim_3.Rdata")
```


```{r}
# Fourth simulation: hub graphs, random direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "hub"
prob = NULL
g = 5
v = 0.3
orient = "random"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_4 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_4, file = "~/ukbb_network/plot_data/bimmer_sim_4.Rdata")
```

```{r}
# Fifth simulation: hub graphs, towards direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "hub"
prob = NULL
g = 5
v = 0.3
orient = "towards"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_5 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_5, file = "~/ukbb_network/plot_data/bimmer_sim_5.Rdata")
```

```{r}
# Sixth simulation: hub graphs, away direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "hub"
prob = 5
g = NULL
v = 0.3
orient = "away"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_6 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_6, file = "~/ukbb_network/plot_data/bimmer_sim_6.Rdata")
```


```{r}
# Seventh simulation: scale-free graphs, random direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "scale-free"
prob = NULL
g = NULL
v = 0.3
orient = "random"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_7 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_7, file = "~/ukbb_network/plot_data/bimmer_sim_7.Rdata")
```


```{r}
# Eigth simulation: scale-free graphs, towards direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "scale-free"
prob = NULL
g = NULL
v = 0.3
orient = "towards"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_8 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_8, file = "~/ukbb_network/plot_data/bimmer_sim_8.Rdata")
```

```{r}
# Ninth simulation: scale-free graphs, away direction.
n_iter = 120
n_cores = 24
N = 100000
M_s = 1000
M_p = 4000
prop_shared = NULL
M_total = 1000000
D = 100
graph = "scale-free"
prob = NULL
g = NULL
v = 0.3
orient = "away"

rho = 0
noise = 0.8 # 20% heritability

methods = c("exact", "inspre", "mvmr")

doMC::registerDoMC(cores = n_cores)
plot_tibble_9 <- foreach(iter = 1:n_iter, .combine = bind_rows, .inorder = FALSE) %dopar% {
  run_methods(iter, N, D, M_total, M_s, M_p, prop_shared, rho, noise, graph, prob, g, v, orient)
}
save(plot_tibble_9, file = "~/ukbb_network/plot_data/bimmer_sim_9.Rdata")
```

```{r}
load("~/Work/saved_rdata/bimmer_sim_10.Rdata")
```

```{r}
beta = 0.025
a <- plot_tibble_10 %>% group_by(iter, method) %>%
  mutate(delta_D = if_else(beta - D_hat > 0, beta - D_hat, Inf)) %>%
  mutate(Method = if_else(method == "glmnet", "elnet-Egger", method)) %>%
  filter(delta_D == min(delta_D) | is.na(delta_D)) %>%
  ggplot(aes(Method, F1)) + geom_violin(alpha = 0.5) +
  labs(x = NULL, y = "F1-score", title = "a) Performance on random graphs") + 
  ylim(0, 1) + theme(plot.title = element_text(size=10))

b <- plot_tibble_10 %>% group_by(iter, method) %>%
  mutate(delta_D = if_else(beta - D_hat > 0, beta - D_hat, Inf)) %>%
  mutate(Method = if_else(method == "glmnet", "elnet-Egger", method)) %>%
  filter(delta_D == min(delta_D) | is.na(delta_D)) %>% ungroup() %>%
  group_by(method) %>%  mutate(run_time_mean = mean(run_time/60)) %>%
  distinct(Method, run_time_mean) %>%
  ggplot(aes(Method, run_time_mean)) + geom_col() +
  labs(x = NULL, y = "Run time (minutes)", title = "b) Run time comparison") + 
  theme(plot.title = element_text(size=10)) + ylim(0, 600) 

ggarrange(a,b,ncol=2, bottom = "Method")
```
